name: Python App & Clean Deploy

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  packages: write

env:
  STACK_NAME: pepito
  IMAGE_NAME: ghcr.io/${{ github.repository }}
  DEPLOY_PATH: /home/${{ secrets.VPS_USER }}/deploy

jobs:

  # üèóÔ∏è BUILD & PUSH IMAGE
  build:
    runs-on: ubuntu-latest
    environment: production   # <= CAMBIA ESTE NOMBRE AL DE TU ENVIRONMENT

    steps:
    - uses: actions/checkout@v4

    - name: üîê Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: üèóÔ∏è Build and Push Docker Image
      run: |
        IMAGE_ID=$(echo "${IMAGE_NAME}" | tr '[:upper:]' '[:lower:]')
        docker build -t $IMAGE_ID:latest .
        docker push $IMAGE_ID:latest

  # üöÄ CLEAN DEPLOY IN VPS
  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: production   # <= CAMBIA ESTE NOMBRE TAMBI√âN

    steps:
    - uses: actions/checkout@v4

    - name: üìÇ Copiar stack.yml al VPS (SCP)
      uses: appleboy/scp-action@v1
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: ${{ secrets.VPS_SSH_PORT }}
        source: "stack.yml"
        target: ${{ env.DEPLOY_PATH }}

    - name: üöÄ Clean Deploy to Docker Swarm (SSH)
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: ${{ secrets.VPS_SSH_PORT }}
        script: |
          IMAGE_ID=$(echo "${IMAGE_NAME}" | tr '[:upper:]' '[:lower:]')
          FULL_IMAGE="$IMAGE_ID:latest"

          echo "--- üöÄ DEPLOY LIMPIO PARA: $STACK_NAME ---"

          cd $DEPLOY_PATH

          echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          echo "üì• Pull de la √∫ltima imagen: $FULL_IMAGE"
          docker pull $FULL_IMAGE

          echo "üî• Eliminando stack anterior..."
          docker stack rm $STACK_NAME || true

          echo "‚è≥ Esperando 15s..."
          sleep 15

          echo "‚ú® Desplegando stack..."
          docker stack deploy --with-registry-auth -c stack.yml $STACK_NAME

          docker service ls
          docker stack ps $STACK_NAME
